import{_ as ee,x as J,v as _,m as ae,u as te,l as se,V as oe,s as j,t as x,y as le,z as re,B as ne,$,a0 as R,I as ie,a1 as ue,a2 as B,a3 as ce}from"./B4Kh-yHs.js";import{ai as y,V as v,ah as t,S,J as N,_ as L,f as de,R as me,r as m,I as r,a0 as p,Q as fe,A as n,ac as E,b as U}from"./CGnq_Kza.js";import{invoke as pe}from"./DxBnVPgq.js";import"./CjwIl2eS.js";const ve={name:"vIconLogin",props:{provider:{type:String,required:!0},loading:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1}},computed:{providerName(){return this.provider.charAt(0).toUpperCase()+this.provider.slice(1)}}};function ge(T,w,f,k,D,s){return v(),y(_,{class:"login-btn",block:"",elevation:"1",loading:f.loading,disabled:f.disabled,onClick:w[0]||(w[0]=b=>T.$emit("click"))},{default:t(()=>[f.loading?S("",!0):(v(),y(J,{key:0,left:"",class:"me-2 google-icon",color:"#EA4335"})),N("span",null,L(f.loading?"Logging in...":`Login with ${s.providerName}`),1)]),_:1},8,["loading","disabled"])}const he=Object.assign(ee(ve,[["render",ge],["__scopeId","data-v-9ab80e44"]]),{__name:"VIconLogin"});async function ye(T,w){await pe("plugin:shell|open",{path:T,with:w})}const _e={key:4,class:"text-center mt-3 mb-2"},we={class:"text-center mt-3 mb-2"},Te={__name:"login",setup(T){const{clearAllCaches:w}=ae(),f=te(),k=se(),D=de(()=>window.isTauri);me(async()=>{try{if(k.isLoggedIn&&k.user){f.push("/home");return}if(await k.ensureUser()){f.push("/home");return}const e=sessionStorage.getItem("oauth_login_data");if(e){const a=JSON.parse(e);sessionStorage.removeItem("oauth_login_data"),a.action==="login"?(C.value=a.userId,s.value=a.username,d.value=a.email,i.value="OAuth login successful!",await O()):a.action==="register"&&(I.value=!0,d.value=a.email,s.value=a.username,i.value="Authorization completed! Please enter username.")}}catch{}});const s=m(""),b=m(""),d=m(""),C=m(""),V=m(!1),I=m(!1),u=m(!1),l=m(""),i=m(""),A=m(!1),O=async()=>{w(),await F(),k.setLoggedIn(!0),await k.fetchUser(),i.value="Session created successfully!",f.push("/home")};function z(){f.push("/register")}const q=()=>{f.push("/")},F=async()=>{try{const e={userId:C.value,username:s.value,email:d.value},a=await fetch("undefined/api/sessions/me",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({user:e})}),c=await a.json();!a.ok||c.error}catch{l.value="Network error"}},H=async()=>{if(!s.value||!b.value){l.value="All fields are required";return}u.value=!0,l.value="",i.value="";const o=void 0;try{const e=await fetch(`${o}/api/auth/local/login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:s.value,password:b.value})}),a=await e.json();!e.ok||a.error?(l.value=a.error,a.error&&a.error.includes("Email not verified")&&(A.value=!0,d.value=s.value)):a.success&&(i.value=a.success,a.user&&(C.value=a.user.userId,s.value=a.user.username,d.value=a.user.email),O())}catch(e){l.value=e}finally{u.value=!1}},M=async o=>{u.value=!0,l.value="",i.value="";try{const a=await(await fetch("undefined/api/auth/oauth",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({token:o.access_token})})).json();a.success==="register"?(P.value=o.access_token,d.value=a.email,s.value=a.username||"",I.value=!0,i.value="Authorization completed! Please enter username."):a.success==="login"?(s.value=a.username,C.value=a.userId,d.value=a.email,O()):a.error&&(l.value=a.error)}catch(e){l.value=e.response?.data?.error||"OAuth login failed"}finally{u.value=!1}},W=()=>{const o=new Uint8Array(32);return crypto.getRandomValues(o),btoa(String.fromCharCode.apply(null,o)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")},G=async o=>{const a=new TextEncoder().encode(o),c=await crypto.subtle.digest("SHA-256",a);return btoa(String.fromCharCode.apply(null,new Uint8Array(c))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")},K=async()=>{if(!u.value){u.value=!0,l.value="",i.value="";try{throw new Error("Desktop OAuth client ID not configured")}catch(o){l.value=o}finally{u.value=!1}}},P=m(""),Q=async()=>{u.value=!0,l.value="",i.value="";const o=void 0;try{const e=await fetch(`${o}/api/auth/google/register`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:s.value,token:P.value})});if(!e.ok)l.value=e.error;else{const a=await e.json();a.success?(i.value=a.success,C.value=a.userId,s.value=a.username,d.value=a.email,O()):a.error&&(l.value=a.error)}}catch{l.value="Network error"}finally{u.value=!1}},Y=async()=>{u.value=!0,l.value="",i.value="";try{const e=await fetch("undefined/api/auth/resend-verification",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:d.value})}),a=await e.json();e.ok?(i.value=a.success,A.value=!1):l.value=a.error||"Failed to resend verification email."}catch{l.value="Network error"}finally{u.value=!1}};return(o,e)=>{const a=he;return v(),y(oe,{class:"fill-height",fluid:""},{default:t(()=>[r(j,{align:"center",justify:"center"},{default:t(()=>[r(x,{cols:"12",sm:"8",md:"4"},{default:t(()=>[r(le,{class:"pa-6",elevation:"8"},{default:t(()=>[r(re,{class:"text-h5 text-center position-relative mb-2"},{default:t(()=>[r(_,{icon:"",variant:"text",onClick:q,class:"position-absolute back-button",style:{left:"0",top:"50%",transform:"translateY(-50%)"}},{default:t(()=>[r(J,null,{default:t(()=>[...e[5]||(e[5]=[p("mdi-arrow-left",-1)])]),_:1})]),_:1}),e[6]||(e[6]=p(" Login ",-1))]),_:1}),r(ne,null,{default:t(()=>[n(I)?(v(),y($,{key:1,onSubmit:E(Q,["prevent"])},{default:t(()=>[r(R,{modelValue:n(s),"onUpdate:modelValue":e[3]||(e[3]=c=>U(s)?s.value=c:null),label:"Username",type:"text","prepend-inner-icon":"mdi-account",required:"",class:"mb-4"},null,8,["modelValue"]),r(_,{type:"submit",color:"primary",block:"",class:"mb-2",loading:n(u),disabled:n(u)},{default:t(()=>[...e[9]||(e[9]=[p(" Login ",-1)])]),_:1},8,["loading","disabled"])]),_:1})):(v(),y($,{key:0,onSubmit:E(H,["prevent"])},{default:t(()=>[r(R,{modelValue:n(s),"onUpdate:modelValue":e[0]||(e[0]=c=>U(s)?s.value=c:null),label:"Username",type:"text","prepend-inner-icon":"mdi-account",required:"",class:"mb-4"},null,8,["modelValue"]),r(R,{modelValue:n(b),"onUpdate:modelValue":e[1]||(e[1]=c=>U(b)?b.value=c:null),type:n(V)?"text":"password",label:"Password","prepend-inner-icon":"mdi-lock","append-inner-icon":n(V)?"mdi-eye":"mdi-eye-off","onClick:appendInner":e[2]||(e[2]=c=>V.value=!n(V)),required:"",class:"mb-4"},null,8,["modelValue","type","append-inner-icon"]),r(_,{type:"submit",color:"primary",block:"",class:"mb-2",loading:n(u),disabled:n(u)},{default:t(()=>[...e[7]||(e[7]=[p(" Login ",-1)])]),_:1},8,["loading","disabled"]),r(ie,{class:"my-4"},{default:t(()=>[...e[8]||(e[8]=[p("OR",-1)])]),_:1}),n(D)?(v(),y(a,{key:1,provider:"google",onClick:K})):(v(),y(n(ue),{key:0,class:"w-100 oauth-button",callback:M,"auto-login":"","popup-type":"TOKEN"},{default:t(()=>[r(a,{provider:"google"})]),_:1}))]),_:1})),n(l)?(v(),y(B,{key:2,type:"error",class:"mt-2"},{default:t(()=>[p(L(n(l)),1)]),_:1})):S("",!0),n(i)?(v(),y(B,{key:3,type:"success",class:"mt-2"},{default:t(()=>[p(L(n(i)),1)]),_:1})):S("",!0),n(A)?(v(),fe("div",_e,[r(_,{variant:"text",color:"primary",size:"small",onClick:Y},{default:t(()=>[...e[10]||(e[10]=[p(" Resend Verification Email ",-1)])]),_:1})])):S("",!0),N("div",we,[r(_,{variant:"text",color:"primary",size:"small",onClick:e[4]||(e[4]=c=>o.$router.push("/forgot-password"))},{default:t(()=>[...e[11]||(e[11]=[p(" Forgot Password? ",-1)])]),_:1})]),r(j,{class:"mt-2",align:"center",justify:"space-evenly"},{default:t(()=>[r(x,{class:"pa-0 text-right",cols:"6"},{default:t(()=>[...e[12]||(e[12]=[N("span",null,"Don't have an account?",-1)])]),_:1}),r(x,{class:"pa-0 text-center",cols:"6"},{default:t(()=>[r(_,{variant:"text",color:"secondary",onClick:E(z,["prevent"])},{default:t(()=>[...e[13]||(e[13]=[p("Sign up",-1)])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})}}};export{Te as default};
