import{r as L,f as E,Q as m,V as c,I as s,ah as a,S,J as t,F as U,am as B,a0 as p,_ as f,T as ae,Z as H,L as X,a2 as ie,ai as V,w as re,R as le,aa as ce,af as de,U as ue}from"./CGnq_Kza.js";import{u as Z}from"./DE-cGGfL.js";import{_ as Y,x as C,a8 as fe,m as W,z as ee,C as te,v as F,B as oe,y as se,V as pe,an as he,ao as me,u as ge,l as ve,e as we,ap as _e,Q as ye,Z as ke,aq as be}from"./B4Kh-yHs.js";import{invoke as D,Resource as G,Channel as K}from"./DxBnVPgq.js";import{s as q}from"./DEKGnF_z.js";import"./CjwIl2eS.js";const Se={class:"global-notifications"},Ce={class:"summary-count"},Ie=["onClick"],xe={class:"notification-icon"},Ne={class:"notification-body"},Te={key:0,class:"notification-title"},Ee={class:"notification-message"},Re={key:1,class:"notification-progress"},$e={class:"progress-bar"},Ae={class:"progress-text"},Ue={key:2,class:"notification-actions"},De=["onClick"],Ve={__name:"GlobalNotifications",setup(g){const e=Z(),n=L(!1),d=E(()=>e.notifications),l=E(()=>n.value?d.value:d.value.slice(0,3)),v=["success","error","warning","info","update"],A=()=>{n.value=!n.value},R=r=>{e.removeNotification(r)},$=r=>({success:"mdi-check-circle",error:"mdi-alert-circle",warning:"mdi-alert",info:"mdi-information",update:"mdi-download"})[r]||"mdi-information",I=r=>({success:"#037F0C",error:"#D13212",warning:"#FF9900",info:"#0073BB",update:"#7D3AC1"})[r]||"#545B64",o=r=>d.value.filter(u=>u.type===r).length,_=r=>n.value?{transform:"translateY(0) scale(1)",zIndex:9e3-r,top:`${52+r*80}px`}:{transform:`translateY(${r*8}px) scale(${1-r*.02})`,zIndex:9e3-r,top:"52px"},k=(r,u)=>{r.handler&&typeof r.handler=="function"&&r.handler(u),u.persistent||R(u.id)};return(r,u)=>(c(),m("div",Se,[s(ae,{name:"fade"},{default:a(()=>[d.value.length>0?(c(),m("div",{key:0,class:"notification-summary-bar",onClick:A},[(c(),m(U,null,B(v,i=>t("span",{key:i,class:"summary-item"},[s(C,{color:I(i),size:"18"},{default:a(()=>[p(f($(i)),1)]),_:2},1032,["color"]),t("span",Ce,f(o(i)),1)])),64)),u[0]||(u[0]=t("span",{class:"summary-divider"},null,-1)),u[1]||(u[1]=t("span",{class:"summary-label"},"Notifications",-1)),s(C,{size:"18",color:"white"},{default:a(()=>[p(f(n.value?"mdi-chevron-up":"mdi-chevron-down"),1)]),_:1})])):S("",!0)]),_:1}),s(ie,{name:"notification-list",tag:"div",class:"notification-stack"},{default:a(()=>[(c(!0),m(U,null,B(l.value,(i,x)=>(c(),m("div",{key:i.id,class:X(["notification-card",`notification-${i.type}`]),style:H(_(x))},[!i.persistent||i.actions?.length===0?(c(),m("button",{key:0,class:"notification-close-btn",onClick:N=>R(i.id)},[s(C,{size:"16"},{default:a(()=>[...u[2]||(u[2]=[p("mdi-close",-1)])]),_:1})],8,Ie)):S("",!0),t("div",xe,[s(C,{color:I(i.type),size:"24"},{default:a(()=>[p(f($(i.type)),1)]),_:2},1032,["color"])]),t("div",Ne,[i.title?(c(),m("div",Te,f(i.title),1)):S("",!0),t("div",Ee,f(i.message),1),i.showProgress?(c(),m("div",Re,[t("div",$e,[t("div",{class:"progress-fill",style:H({width:`${i.progress}%`})},null,4)]),t("span",Ae,f(Math.round(i.progress))+"%",1)])):S("",!0),i.actions?.length>0?(c(),m("div",Ue,[(c(!0),m(U,null,B(i.actions,N=>(c(),m("button",{key:N.label,class:X(["action-btn",N.color==="primary"?"action-btn-primary":"action-btn-secondary"]),onClick:M=>k(N,i)},f(N.label),11,De))),128))])):S("",!0)])],6))),128))]),_:1})]))}},Pe=Y(Ve,[["__scopeId","data-v-5ccf788d"]]),Be={class:"text-caption mb-2"},Fe={class:"text-caption mb-2"},Le={class:"text-caption mb-2"},Me={key:0,class:"text-caption"},ze={class:"flex-grow-1"},Oe={class:"text-caption mt-2"},Ye={class:"text-caption"},je={__name:"CacheDebugger",setup(g){const e=fe(),{getCacheStats:n,removeTeamFromCache:d}=W(),l=L(!1),v=E(()=>n()),A=E(()=>`${e.name} (${e.path})`),R=E(()=>!1),$=I=>{d(I),e.params.teamId===I&&window.location.reload()};return(I,o)=>(c(),m(U,null,[l.value?(c(),V(se,{key:0,class:"cache-debugger ma-2",variant:"outlined"},{default:a(()=>[s(ee,{class:"text-subtitle-2 py-2"},{default:a(()=>[s(C,{start:"",size:"small"},{default:a(()=>[...o[2]||(o[2]=[p("mdi-cached",-1)])]),_:1}),o[4]||(o[4]=p(" Cache Debug Panel ",-1)),s(te),s(F,{icon:"",size:"x-small",onClick:o[0]||(o[0]=_=>l.value=!1)},{default:a(()=>[s(C,null,{default:a(()=>[...o[3]||(o[3]=[p("mdi-close",-1)])]),_:1})]),_:1})]),_:1}),s(oe,{class:"py-2"},{default:a(()=>[t("div",Be,[o[5]||(o[5]=t("strong",null,"Active Components:",-1)),p(" "+f(v.value.totalCachedComponents),1)]),t("div",Fe,[o[6]||(o[6]=t("strong",null,"Cached Teams:",-1)),p(" "+f(v.value.cachedTeams),1)]),t("div",Le,[o[7]||(o[7]=t("strong",null,"Current Route:",-1)),p(" "+f(A.value),1)]),Object.keys(v.value.teamCacheDetails).length>0?(c(),m("div",Me,[o[8]||(o[8]=t("div",null,[t("strong",null,"Team Cache Details:")],-1)),(c(!0),m(U,null,B(v.value.teamCacheDetails,(_,k)=>(c(),m("div",{key:k,class:"ml-2 d-flex align-center"},[t("div",ze," â€¢ "+f(k)+": "+f(_.componentKey)+" ("+f(_.lastAccessed)+", expires "+f(_.expiresIn)+") ",1),s(F,{size:"x-small",variant:"text",icon:"mdi-refresh",onClick:r=>$(k),title:`Force refresh team ${k}`},null,8,["onClick","title"])]))),128))])):S("",!0),t("div",Oe,[o[9]||(o[9]=t("strong",null,"Cache Expiry:",-1)),p(" "+f(v.value.cacheExpiryMinutes)+" minutes ",1)]),t("div",Ye,[o[10]||(o[10]=t("strong",null,"Expired Entries Cleaned:",-1)),p(" "+f(v.value.expiredEntriesRemoved),1)])]),_:1})]),_:1})):S("",!0),!l.value&&R.value?(c(),V(F,{key:1,fab:"",fixed:"",bottom:"",right:"",size:"small",color:"primary",class:"cache-debug-fab",onClick:o[1]||(o[1]=_=>l.value=!0)},{default:a(()=>[s(C,null,{default:a(()=>[...o[11]||(o[11]=[p("mdi-cached",-1)])]),_:1})]),_:1})):S("",!0)],64))}},He=Object.assign(Y(je,[["__scopeId","data-v-a2ae2c26"]]),{__name:"CacheDebugger"}),Xe={class:"footer-right"},Ge={class:"footer-status"},Ke={__name:"TMFooter",setup(g){return(e,n)=>(c(),V(he,{class:"tm-footer",padless:""},{default:a(()=>[s(pe,{class:"d-flex justify-space-between align-center",style:{"min-height":"36px"}},{default:a(()=>[n[2]||(n[2]=t("div",{class:"footer-left"},[t("span",{class:"font-weight-bold tm-footer-title"},"TM-Project"),t("span",{class:"mx-2"},"|"),t("a",{href:"/privacy-policy",class:"footer-link"},"Privacy Policy"),t("span",{class:"mx-2"},"|"),t("a",{href:"/terms-of-service",class:"footer-link"},"Terms of Service"),t("span",{class:"mx-2"},"|"),t("a",{href:"/about",class:"footer-link"},"About")],-1)),t("div",Xe,[t("span",Ge,[s(C,{color:"primary",size:"18"},{default:a(()=>[...n[0]||(n[0]=[p("mdi-check-circle",-1)])]),_:1}),n[1]||(n[1]=t("span",{class:"ml-1"},"All systems normal.",-1))])])]),_:1})]),_:1}))}},qe=Y(Ke,[["__scopeId","data-v-ed383981"]]);class Je extends G{constructor(e){super(e.rid),this.available=!0,this.currentVersion=e.currentVersion,this.version=e.version,this.date=e.date,this.body=e.body,this.rawJson=e.rawJson}async download(e,n){O(n);const d=new K;e&&(d.onmessage=e);const l=await D("plugin:updater|download",{onEvent:d,rid:this.rid,...n});this.downloadedBytes=new G(l)}async install(){if(!this.downloadedBytes)throw new Error("Update.install called before Update.download");await D("plugin:updater|install",{updateRid:this.rid,bytesRid:this.downloadedBytes.rid}),this.downloadedBytes=void 0}async downloadAndInstall(e,n){O(n);const d=new K;e&&(d.onmessage=e),await D("plugin:updater|download_and_install",{onEvent:d,rid:this.rid,...n})}async close(){await this.downloadedBytes?.close(),await super.close()}}async function J(g){O(g);const e=await D("plugin:updater|check",{...g});return e?new Je(e):null}function O(g){g?.headers&&(g.headers=Array.from(new Headers(g.headers).entries()))}async function Qe(){await D("plugin:process|restart")}class Ze{constructor(){this.notificationStore=null,this.updateInProgress=!1,this.updateNotificationId=null,this.progressNotificationId=null}init(e){this.notificationStore=e}async checkForUpdates(){this.notificationStore;try{const e=await J();e?this.showUpdateConfirmation(e):this.notificationStore.showInfo("You are running the latest version",{title:"No Updates Available"})}catch(e){this.notificationStore.showError("Failed to check for updates. Please try again later.",{title:e})}}showUpdateConfirmation(e){e.body&&`${e.body}`,this.updateNotificationId=this.notificationStore.showUpdateConfirmation(e,()=>this.downloadAndInstallUpdate(e),()=>this.declineUpdate())}async downloadAndInstallUpdate(e){if(!this.updateInProgress){this.updateInProgress=!0,this.updateNotificationId&&(this.notificationStore.removeNotification(this.updateNotificationId),this.updateNotificationId=null);try{let n=0,d=0;this.progressNotificationId=this.notificationStore.showUpdateProgress(0),await e.downloadAndInstall(l=>{switch(l.event){case"Started":d=l.data.contentLength,this.progressNotificationId||(this.progressNotificationId=this.notificationStore.showUpdateProgress(0));break;case"Progress":n+=l.data.chunkLength;const v=d>0?n/d*100:0;this.progressNotificationId&&this.notificationStore.updateNotificationProgress(this.progressNotificationId,v);break;case"Finished":this.progressNotificationId&&(this.notificationStore.removeNotification(this.progressNotificationId),this.progressNotificationId=null),this.notificationStore.showSuccess("Update installed successfully. The application will restart now.",{title:"Update Complete",duration:3e3});break}}),setTimeout(async()=>{try{await Qe()}catch{this.notificationStore.showError("Update installed but failed to restart automatically. Please restart the application manually.",{title:"Restart Required"})}},2e3)}catch(n){this.progressNotificationId&&(this.notificationStore.removeNotification(this.progressNotificationId),this.progressNotificationId=null),this.notificationStore.showError(`Failed to download or install update: ${n}`,{title:"Update Failed",duration:1e4})}finally{this.updateInProgress=!1}}}declineUpdate(){this.updateNotificationId&&(this.notificationStore.removeNotification(this.updateNotificationId),this.updateNotificationId=null)}async checkForUpdatesOnStartup(){if(this.notificationStore)try{const e=await J();e&&this.notificationStore.showInfo(`Version ${e.version} is available. Click here to install.`,{title:"Update Available",duration:8e3,actions:[{label:"Install Now",color:"primary",handler:()=>this.downloadAndInstallUpdate(e)},{label:"View Details",color:"grey",variant:"outlined",handler:()=>this.showUpdateConfirmation(e)}]})}catch{}}async getCurrentVersion(){try{return"1.0.0"}catch{return"Unknown"}}}const Q=new Ze,at={__name:"default",setup(g){const e=me(),n=ge(),d=we(),l=ve(),v=Z(),{initializeMainViews:A,cleanExpiredCache:R,clearAllCaches:$}=W(),I=E(()=>{const h=d.public.dev;return h!==void 0?h==="true":!1}),o=L(!1),_=L(""),k=(h="You have been signed out.")=>{_.value=h,o.value=!0,l.clearAuth(),$(),z()},r=()=>{o.value=!1,n.push("/login")},u=E(()=>e.matched.some(h=>h.meta.requiresAuth)),i=[{title:"Login",icon:"mdi-login",to:"/login"},{title:"Sign Up",icon:"mdi-account-plus",to:"/register"},{title:"Docs",icon:"mdi-book-open-variant",to:"/docs"}];let x=null;const N=async()=>{let b=0;for(;b<3;)try{const P=d.public.apiPort,T=await fetch(`${P}/api/sessions/refresh`,{method:"POST",credentials:"include"});if(T.ok)return l.setLoggedIn(!0),l.user||await l.fetchUser(),!0;if(T.status===401){try{const y=await T.json();if(y.error==="TOKEN_REVOKED"||y.error==="TOKEN_INVALID")return k(y.message||"You have been signed out."),!1}catch{}if(l.clearAuth(),b<2){await new Promise(y=>setTimeout(y,2e3)),b++;continue}return!1}else{if(b<2){await new Promise(y=>setTimeout(y,2e3)),b++;continue}return!1}}catch{if(b<2){await new Promise(T=>setTimeout(T,2e3)),b++;continue}return l.clearAuth(),!1}return!1},M=()=>{x&&clearInterval(x),x=q(async()=>{if(u.value){const h=await N()}},720*1e3)},z=()=>{x&&(clearInterval(x),x=null)};re(u,h=>{h?M():z()},{immediate:!0});const j=h=>{const w=h.detail?.message||"Your session has been terminated. Please sign in again.";k(w)};return le(()=>{N(),u.value&&M(),A(),Q.init(v),window.isTauri&&setTimeout(()=>{Q.checkForUpdatesOnStartup()},2e3),q(()=>{R()>0},300*1e3),window.addEventListener("token-revoked",j)}),ce(()=>{z(),window.removeEventListener("token-revoked",j)}),(h,w)=>{const b=de("SideBar"),P=Pe,T=He,y=qe;return c(),V(be,null,{default:a(()=>[s(b,{landingLinks:i}),s(_e,null,{default:a(()=>[ue(h.$slots,"default")]),_:3}),s(P),s(ye,{modelValue:o.value,"onUpdate:modelValue":w[0]||(w[0]=ne=>o.value=ne),"max-width":"500",persistent:""},{default:a(()=>[s(se,null,{default:a(()=>[s(ee,{class:"text-h5 d-flex align-center"},{default:a(()=>[s(C,{color:"warning",class:"mr-2"},{default:a(()=>[...w[1]||(w[1]=[p("mdi-logout",-1)])]),_:1}),w[2]||(w[2]=p(" Signed Out ",-1))]),_:1}),s(oe,null,{default:a(()=>[t("p",null,f(_.value),1)]),_:1}),s(ke,null,{default:a(()=>[s(te),s(F,{color:"primary",variant:"elevated",onClick:r},{default:a(()=>[...w[3]||(w[3]=[p(" Go to Login ",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),I.value?(c(),V(T,{key:0})):S("",!0),s(y)]),_:3})}}};export{at as default};
